<%- include("./partials/header") %>

<body>
    <div class="parent">
        <div class="Navguide">
            <a href="/"> <h1>Tilbake</h1></a>
            <% if (isloggedin){ %>
                <a href="/dashboard"><h2>Profile</h2></a>
            <% } else { %>
                <a href="/login"><h2>Logg inn</h2></a>
            <% } %>
        </div>
        <div class="background">
            <div id="guide<%= guide._id %>" class="guides-container">
                <h1 class="tittle-class"><%= guide.tittel %></h1>
                <p class="tag-class"><%= guide.tag %></p>
                <div class="texton">
                    <% if (guide.overskrift && guide.beskrivelse && guide.bilde && guide.overskrift.length > 0) { %>
                        <% for (let index = 0; index < guide.overskrift.length; index++) { %>
                            <div>
                                <h2><%= guide.overskrift[index] %></h2>
                                <p><%= guide.beskrivelse[index] %></p>
                                <img src="/uploads/<%= guide.bilde[index] %>" class="bilder" alt="Bilde <%= index + 1 %>">
                            </div>
                        <% } %>
                    <% } else { %>
                        <p>There is no content to display</p>
                    <% } %>
                    

                    <p>Created by: <%= guide.creator ? guide.creator.email : 'Unknown' %></p>

                    <% if (isloggedin && guide.creator && guide.creator._id && user && user._id && guide.creator._id.toString() === user._id.toString()) { %>
                        <!-- Edit button for logged-in creator -->
                        <button class="editButton" data-id="<%= guide._id %>">Rediger</button>
                        <button class="saveButton" data-id="<%= guide._id %>" style="display:none;">Lagre</button>
                        <form action="/guide/<%= guide._id %>/delete" method="POST" onsubmit="return confirm('Er du sikker pÃ¥ at du vil slette denne guiden?');" style="display:inline;">
                            <button type="submit" class="deleteButton">Slett</button>
                        </form>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll(".editButton").forEach(button => {
            button.addEventListener("click", function () {
                const guideId = button.getAttribute("data-id");
                const textDiv = document.querySelector(`#guide${guideId}`);
    
                const titleElement = textDiv.querySelector("h1");
                const tagElement = textDiv.querySelector(".tag-class");
                const headerElements = textDiv.querySelectorAll("h2");
                const descriptionElements = textDiv.querySelectorAll("p:not(.tag-class):not(:last-child)"); // Adjust to match all paragraphs except the tag and last p
                const imgElements = textDiv.querySelectorAll("img");
    
                let headers = [];
                headerElements.forEach((header) => {
                    headers.push(header.textContent); // Extract header value
                });
    
                let descriptions = [];
                descriptionElements.forEach((description) => {
                    descriptions.push(description.textContent);
                });
    
                let images = [];
                imgElements.forEach((img) => {
                    images.push(img.src.split('/uploads/')[1]); // Extract image filename from the path
                });
    
                const title = titleElement.textContent;
                const tag = tagElement.textContent;
    
                // Generate editable form
                textDiv.innerHTML = `
                    <form action="/guide/${guideId}/edit" method="POST" enctype="multipart/form-data">
                        <div class="texton2">
                            <input type="text" name="tittel" value="${title}" required/>
                            <input type="text" name="tag" value="${tag}" required/>
    
                            <!-- Edit existing headers and descriptions -->
                            <div id="sections">
    ${headers.map((header, index) => `
        <div class="section">
            <label for="overskrift${index}">Header ${index + 1}:</label>
            <input type="text" name="overskrift" value="${header}" required/>
            
            <label for="beskrivelse${index}">Description ${index + 1}:</label>
            <textarea name="beskrivelse" required>${descriptions[index]}</textarea>
            
            <p>Bilde ${index + 1}: ${images[index]}</p>
            <label for="bilde${index}">Velg fil:</label>
            <input type="file" name="bilde" accept="image/*"/> <!-- This is where the user can upload a new image -->
            <input type="hidden" name="oldBilde" value="${images[index]}"/> <!-- Keep track of the old image filename -->
        </div>
    `).join('')}
</div>

                
    
                            <button type="submit">Lagre endringer</button>
                        </div>
                    </form>
                `;
    
                // // Add functionality to add new sections
                // document.getElementById("addSection").addEventListener("click", function () {
                //     const sectionsDiv = document.getElementById("sections");
                //     const newIndex = sectionsDiv.querySelectorAll(".section").length; // Get current number of sections
    
                //     // Append new header, description, and file input
                //     sectionsDiv.insertAdjacentHTML('beforeend', `
                //         <div class="section">
                //             <label for="overskrift${newIndex}">Header ${newIndex + 1}:</label>
                //             <input type="text" name="overskrift" required/>
    
                //             <label for="beskrivelse${newIndex}">Description ${newIndex + 1}:</label>
                //             <textarea name="beskrivelse" required></textarea>
    
                //             <label for="bilde${newIndex}">Velg fil:</label>
                //             <input type="file" name="bilde" accept="image/*"/>
                //         </div>
                //     `);
            });
        });
    </script>
    
</body>
</html>